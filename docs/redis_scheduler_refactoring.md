## Redis와 Scheduler를 이용한 쿠폰 발급 리팩토링

### 1. 문제점
- 기존 쿠폰 발급 로직은 쿠폰 발급 요청이 들어올 때마다 DB에 접근하여 쿠폰을 발급하고, 발급된 쿠폰을 DB에 저장하는 방식으로 동작하고 있었다.
- 이로 인해 쿠폰 발급 요청이 많아질수록 DB에 부하가 커지는 문제가 발생할 것으로 예상.

### 2. 해결 방안
- 비동기 방식으로 Redis를 이용하여 쿠폰 발급 요청을 받으면 Redis에 쿠폰 발급 요청을 저장하고, Scheduler를 이용하여 Redis에 저장된 쿠폰 발급 요청을 일정 시간마다 확인하여 쿠폰을 발급하고, 발급된 쿠폰을 DB에 저장하는 방식으로 변경하였다.

### 3. 구현 방법
- Coupon requestCoupon() 메소드를 호출하여 쿠폰 발급 요청을 받으면, Redis에 쿠폰 발급 요청을 저장한다.
  - 쿠폰 발급내역을 검증한다.
- Scheduler를 이용하여 Redis에 저장된 쿠폰 발급 요청을 일정 시간마다 확인하여 쿠폰을 발급하고, 발급된 쿠폰을 DB에 저장한다.
- 쿠폰 발급이 성공하면 Redis에 저장된 쿠폰 발급 요청을 삭제하고 쿠폰 발급 내역을 issuedCoupon:couponId-userId 형태로 저장한다.
- DB에도 쿠폰 발급 내역을 저장한다.

### 4. 분산환경을 고려하여 스케줄러에 Redis 분산락을 적용하여 중복 발급 방지
- 다수의 서버가 존재할 경우 스케줄러가 동시에 쿠폰 발급 요청을 확인하여 중복 발급이 발생할 수 있다.
  - (.e.g 서버1, 서버2가 동시에 sorted set에 저장된 쿠폰요청 사이즈를 확인하여 의도치 않은 쿠폰 발급 요청이 있을 수 있음.)
- 스케줄러가 쿠폰 발급 요청을 확인하여 쿠폰을 발급할 때, Redis 분산락을 이용하여 중복 발급을 방지한다.

### 5. 테스트 내용
- 쿠폰 요청 후 Redis에 쿠폰요청이 저장되는지 테스트
- 쿠폰 발급 후 Redis에 쿠폰이 발급내역이 저장되었는지 테스트
- 분산 서버 환경에서 스케줄러가 동시에 실행될 경우 쿠폰 요청 만큼의 쿠폰이 발급되었는지, 발급 후 DB에 저장된 쿠폰 잔여수량이 쿠폰 요청 만큼 감소되었는지 테스트